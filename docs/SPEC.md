# SnapShoot - 기능 명세서 (SPEC)

## 1. 개요

**SnapShoot**는 3D 환경에서 진행되는 승부차기 축구 게임입니다. 사용자는 마우스나 터치 스와이프를 통해 공을 차고, 골대에 공을 넣으면 점수를 1점 획득합니다. 현재 프로토타입 단계로, 향후 오락실 농구 게임처럼 점진적으로 난이도가 상승하는 모드가 추가될 예정입니다.

## 2. 주요 기능

-   **3D 그래픽 렌더링**: `Three.js`를 사용한 3D 게임 환경 구축.
-   **물리 엔진**: `cannon-es`를 활용한 현실적인 공의 물리 시뮬레이션 (중력, 충돌, 반발).
-   **스와이프 기반 슈팅**: 사용자의 스와이프 입력을 분석하여 공의 속도, 방향, 커브, 스핀을 결정하는 정교한 슈팅 메커니즘.
-   **동적 골키퍼**: 3D 모델링된 골키퍼가 구현되어 있음. (2D 이미지 기반 골키퍼와 3D 모델 기반 골키퍼 2가지 버전이 구현되어 있으며, 현재는 3D 골키퍼가 활성화됨. 3D 골키퍼는 Idle 애니메이션을 재생하지만, 실제 공 추적 및 방어 로직은 미구현 상태)
-   **스코어 시스템**: 골 성공 시 점수가 1점씩 증가하고 UI에 즉시 반영. 골 실패 시 점수가 0으로 리셋됨.
-   **게임 환경**: 축구장, 골대, 관중석, 광고판 등 몰입감을 높이는 다양한 환경 요소 구현.
-   **오디오 시스템**: 킥, 골, 세이브, 골대 강타 등 다양한 상황에 맞는 효과음 재생.
-   **UI 시스템**: 로딩 화면, 점수 표시, 디버그 HUD 등 게임 플레이에 필요한 UI 요소.
-   **설정 기반 개발**: 게임의 주요 파라미터(공, 골대, 필드, 슈팅, 골키퍼, 스트라이크 존 등)를 `src/config` 폴더에서 쉽게 조정할 수 있는 구조.

## 3. 세부 기능 명세

### 3.1. 코어 시스템 (`src/core`)

-   **그래픽스 (`graphics.ts`)**: `Three.js`의 `WebGLRenderer`를 초기화하고, 그림자(PCFSoftShadowMap), 색 공간(SRGB), 톤 매핑(ACESFilmic) 등 고품질 렌더링 옵션을 설정.
-   **카메라 (`camera.ts`)**: 원근 카메라(`PerspectiveCamera`)를 생성하고 게임에 적합한 초기 위치와 시야각(FOV)을 설정.
-   **조명 (`lighting.ts`)**: `AmbientLight`(전역광), `HemisphereLight`(반구광), `DirectionalLight`(방향광), `PointLight`(점광원) 등을 조합하여 사실적인 조명 환경을 구성. 주 방향광은 그림자를 생성.
-   **오디오 (`audio.ts`)**: Web Audio API를 사용하여 사운드 에셋을 비동기적으로 로드하고, `play` 메서드를 통해 특정 사운드를 재생. (킥, 골, 바운스, 세이브, 포스트, 리셋, 그물 소리)

### 3.2. 물리 엔진 (`src/physics`)

-   **물리 세계 (`world.ts`)**: `cannon-es` 월드를 생성하고, 중력(`-18.81 m/s²`)을 설정. `SAPBroadphase`와 `GSSolver`를 사용하여 충돌 감지 성능과 정확도를 향상.
-   **물리 상수 (`constants.ts`)**: 중력, 공기 저항 등 물리 관련 상수를 중앙에서 관리.
-   **재질**: 공, 지면, 골대 등 각 개체의 물리적 상호작용(마찰, 반발력)을 정의하는 `ContactMaterial`을 설정.

### 3.3. 게임 엔티티 (`src/entities`)

-   **공 (`ball.ts`)**:
    -   3D 모델(`soccer_ball.gltf`)을 로드하여 시각적 표현.
    -   `CANNON.Sphere` 형태의 물리 바디를 가지며, 질량, 감쇠 등 물리 속성이 `config/ball.ts`에서 설정됨.
    -   `reset` 메서드를 통해 초기 위치와 상태로 되돌릴 수 있음.
-   **골대 (`goal.ts`)**:
    -   골포스트, 크로스바 등 골대 구조물을 `THREE.Mesh`와 `CANNON.Body`로 각각 생성.
    -   골 판정을 위한 보이지 않는 센서(`CANNON.Body`)를 내부에 포함.
-   **골키퍼 (`goalkeeper.ts`, `goalkeeper3d.ts`)**:
    -   **`goalkeeper.ts`**: 2D 이미지를 사용한 간단한 골키퍼. 공의 위치에 따라 Z축 회전으로 반응하는 기본적인 방어 로직. 현재 `game.ts`에서는 주석 처리되어 비활성화됨.
    -   **`goalkeeper3d.ts`**: FBX 모델(`Ch38_nonPBR.fbx`)과 애니메이션(`goalkeeper idle.fbx`)을 사용하는 3D 골키퍼. 현재 활성화된 버전. `AnimationMixer`를 통해 Idle 애니메이션을 재생하며, 전용 조명(SpotLight, PointLight)을 포함. `startTracking()`, `stopTracking()` 메서드가 정의되어 있으나 실제 공 추적 및 방어 로직은 미구현 상태. 골키퍼 설정은 `config/players.ts`에서 관리.
-   **골 그물 (`goalNet.ts`, `goalNetAnimator.ts`)**:
    -   `goalNet.ts`: 수많은 노드(Node)와 엣지(Edge)로 구성된 절차적 그물망을 생성.
    -   `goalNetAnimator.ts`: 공이 그물에 닿았을 때 충격 지점을 중심으로 파동이 퍼져나가는 시뮬레이션과, 평상시 바람에 살짝 흔들리는 효과를 구현.

### 3.4. 게임 환경 (`src/environment`)

-   **필드 (`field.ts`)**:
    -   잔디 텍스처(Color, Normal, AO, Roughness)가 적용된 지면을 생성.
    -   필드 라인(골 라인, 페널티 박스, 페널티 아크)을 `THREE.Mesh`로 구현.
    -   움직이는 광고판(`AdBoard`)을 구현하여 동적인 환경을 연출.
-   **관중석 (`stands.ts`)**:
    -   삼각기둥 형태의 관중석 모델을 절차적으로 생성.
    -   관중 텍스처를 적용하여 경기장 분위기를 연출.

### 3.5. 슈팅 메커니즘 (`src/input`, `src/shooting`)

슈팅은 여러 단계의 정교한 계산을 통해 이루어집니다.

1.  **입력 추적 (`input/swipeTracker.ts`)**:
    -   사용자의 `pointerdown`, `pointermove`, `pointerup` 이벤트를 추적하여 스와이프 경로와 시간 정보를 수집.
    -   수집된 포인트를 5개의 대표 지점(0%, 25%, 50%, 75%, 100%)으로 샘플링.

2.  **스와이프 정규화 (`shooting/swipeNormalizer.ts`)**:
    -   스와이프 시작점을 (0,0)으로, 끝점을 (1,0)으로 변환하여 모든 스와이프를 동일한 좌표계로 표준화.
    -   이 과정에서 스와이프의 속도, 각도, 수평/수직 이동 거리 등의 기본 데이터를 계산.

3.  **슛 타입 분석 (`shooting/shotAnalyzer.ts`)**:
    -   정규화된 경로의 곡률을 분석하여 슛의 종류를 `NORMAL`(직선) 또는 `CURVE`(곡선)로 판별.
    -   스와이프 속도로 `power`(세기)를, 수직 이동 거리로 `heightFactor`(높이)를 계산.

4.  **슛 파라미터 계산 (`shooting/shotParameters.ts`)**:
    -   분석된 슛 타입과 파라미터를 바탕으로 3D 공간상의 최종 목표 지점(`targetPosition`)을 결정.
    -   `CURVE` 슛의 경우, 공이 휘어 들어올 것을 감안하여 조준점(`aimTargetPosition`)을 골대 바깥쪽으로 보정.

5.  **초기 속도 계산 (`shooting/velocityCalculator.ts`)**:
    -   물리 법칙(등가속도 운동)에 기반하여, 계산된 조준점까지 정해진 시간(`power`에 반비례) 안에 공이 도달하기 위한 초기 3D 속도 벡터(`vx`, `vy`, `vz`)를 계산.

6.  **스핀 계산 (`shooting/spinCalculator.ts`)**:
    -   `CURVE` 슛의 경우, 커브 방향과 강도에 따라 공의 초기 회전(각속도, `angularVelocity`)을 부여.

7.  **커브 힘 적용 (`shooting/curveForceSystem.ts`)**:
    -   `CURVE` 슛이 발사된 후, 공이 날아가는 동안 속도 벡터에 수직인 힘(마그누스 효과)을 지속적으로 가하여 시각적으로 공이 휘어지는 궤적을 생성.

### 3.6. UI (`src/ui`)

-   **로딩 화면 (`loadingScreen.ts`)**: 게임 에셋 로딩 진행률을 표시하는 동적인 로딩 화면. Three.js 에셋과 오디오 로딩 진행률을 각각 추적하여 통합 진행률(85%/15% 가중치)을 표시. 축구 테마의 재치 있는 메시지들을 순차적으로 보여줌.
-   **디버그 HUD (`debugHud.ts`, `shotInfoHud.ts`)**:
    -   디버그 모드를 켜고 끌 수 있는 버튼을 제공.
    -   디버그 모드 활성화 시, 슛의 상세 정보(타입, 세기, 커브, 속도 등)를 화면 하단에 표시.
    -   또한, 물리 콜라이더, 공의 궤적, 스와이프 경로(5개 포인트 마커와 번호 레이블 포함), 타겟 마커, 축 화살표 등을 시각적으로 표시.
    -   실시간 궤적 추적 로깅 시스템을 통해 공의 위치와 속도를 콘솔에 출력.

### 3.7. 설정 파일 (`src/config`)

-   **`ball.ts`**: 공의 반지름, 시작 위치, 질량, 감쇠 등 물리 속성 정의.
-   **`goal.ts`**: 골대의 너비, 높이, 깊이, 포스트 반지름 등 정의.
-   **`net.ts`**: 골 그물의 레이아웃, 노드 간격, 스프링 강성, 감쇠 등 정의.
-   **`field.ts`**: 필드 크기, 오프셋, 스트라이프 패턴, 텍스처 반복 등 정의.
-   **`shooting.ts`**: 슈팅 파워, 높이, 커브 강도 등의 범위 및 계수 정의.
-   **`players.ts`**: 골키퍼의 너비, 높이, 깊이, 회전 범위 등 정의.
-   **`strike.ts`**: 스트라이크 존의 클램프 범위, 폴오프 경사, 가이드 투명도 등 정의.
-   **`stands.ts`**: 관중석 설정.
-   **`adBoard.ts`**: 광고판 크기, 위치, 이동 속도 등 정의.

## 4. 향후 개발 고려사항

사용자가 언급한 내용과 코드 분석을 통해 도출된 주요 개선점은 다음과 같습니다.

-   **3D 골키퍼 AI 구현** (우선순위 높음):
    -   현재 3D 골키퍼(`goalkeeper3d.ts`)는 Idle 애니메이션만 재생하고, `startTracking()`, `stopTracking()` 메서드는 콘솔 로그만 출력함.
    -   공의 궤적을 예측하여 실제로 움직이는 로직 구현 필요.
    -   다양한 방어 애니메이션(좌/우 점프, 다이빙, 높은 공 세이브 등) 추가 및 상태 머신(State Machine) 구축 필요.
-   **골키퍼 난이도 조절**:
    -   게임 난이도(또는 점수)에 따라 골키퍼의 반응 속도, 최대 이동 거리, 방어 성공률 등을 조절하는 로직 필요.
    -   예: 점수가 높아질수록 더 빠르게, 더 넓은 범위를 방어.
-   **게임 모드 및 스코어 시스템 개선**:
    -   현재는 골 실패 시 점수가 0으로 리셋되는 단순한 방식.
    -   점수가 누적되고 특정 점수 도달 시 난이도가 상승하는 '아케이드 모드' 구현 고려.
    -   연속 골 성공 시 콤보 점수, 제한 시간 내 목표 점수 달성 등의 게임 모드 추가 가능.
-   **다양한 슛 컨트롤**: 현재 스와이프 패턴 외에, 공의 특정 부분을 터치하여 스핀의 종류(예: 탑스핀, 백스핀)를 제어하는 등 추가적인 컨트롤 방식 도입 고려.
-   **README.md 작성**: 현재 거의 비어있는 상태이므로, 프로젝트 소개, 설치 방법, 실행 방법, 기능 설명 등을 포함한 상세한 문서 작성 필요.
