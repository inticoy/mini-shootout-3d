# 리팩토링 계획서 📋

## 프로젝트 개요
3D 축구 슈팅 게임 (Snapshoot) - Three.js + Cannon.js 기반

---

## 🔴 Priority 1: 즉시 필요

### 문제점 1: Game 클래스 비대화 (1,300+ 줄)

**현재 상황:**
- game.ts 파일 하나에 모든 로직 집중
- 렌더링, 물리, 입력, 사운드, 난이도가 한 클래스에 혼재
- 코드 찾기 어렵고, 수정 시 사이드 이펙트 위험

**해결 방안:**
```
game.ts 분리 계획:
├─ GameEngine.ts (300줄) - 게임 루프, 상태 관리, 라이프사이클
├─ PhysicsManager.ts (250줄) - 물리 시뮬레이션, 충돌 감지
├─ InputManager.ts (150줄) - 터치/마우스/키보드 입력
├─ BallController.ts (200줄) - 공 관련 로직, 커브
├─ DifficultyManager.ts (150줄) - 난이도 조절, 장애물
└─ SceneManager.ts (250줄) - Three.js 씬, 카메라, 렌더링
```

**효과:**
- 파일당 150-300줄로 관리 용이
- 버그 추적 시간 50% 단축
- 팀 협업 시 충돌 최소화

---

### 문제점 2: 상태 관리 분산

**현재 상황:**
- localStorage 접근이 여러 파일에 흩어짐
- 키 이름 중복 가능성
- 상태 변경 추적 어려움

**해결 방안:**
```
state/GameStateManager.ts 생성:
- 싱글톤 패턴으로 중앙 관리
- localStorage 접근 캡슐화
- 타입 안전성 보장
```

**관리 대상:**
- 오디오 설정 (music, sfx, volume)
- 베스트 스코어
- 테마 선택
- 튜토리얼 완료 여부

**효과:**
- 상태 변경 한 곳에서 제어
- 디버깅 용이
- 로컬스토리지 키 충돌 방지

---

## 🟡 Priority 2: 다음 단계

### 문제점 3: 타입 정의 분산

**현재 상황:**
- 타입이 각 파일마다 정의됨
- 중복 타입 존재 가능성
- 타입 찾기 어려움

**해결 방안:**
```
types/ 폴더 생성:
├─ game.types.ts (게임 상태, 난이도, 점수)
├─ ui.types.ts (모달, 컴포넌트 props)
├─ physics.types.ts (충돌, 속도, 위치)
└─ index.ts (통합 export)
```

**효과:**
- 타입 재사용 증가
- 타입 변경 시 영향 범위 명확
- IDE 자동완성 개선

---

### 문제점 4: 에러 처리 부족

**현재 상황:**
- try-catch 블록 최소화
- 에러 발생 시 앱 크래시 가능
- 사용자에게 에러 메시지 없음

**해결 방안:**
```
utils/ErrorHandler.ts 생성:
- 에러 분류 (네트워크, 물리, 렌더링)
- 사용자 친화적 메시지 표시
- 에러 로깅 (추후 분석용)
```

**적용 위치:**
- 에셋 로딩 실패
- localStorage 접근 실패
- Three.js/Cannon.js 초기화 실패

---

## 🟢 Priority 3: 여유 있을 때

### 문제점 5: 콜백 지옥

**현재 상황:**
- 컴포넌트 간 콜백 함수로 통신
- 결합도 높음
- 의존성 복잡

**해결 방안:**
```
events/EventBus.ts 도입:
- pub/sub 패턴
- 이벤트 기반 통신
- 느슨한 결합
```

**이벤트 타입 예시:**
- score-changed
- game-failed
- theme-switched
- difficulty-increased

---

### 문제점 6: Config 통합 부재

**현재 상황:**
- config 파일 많지만 관리 어려움
- 설정 값 찾기 위해 여러 파일 확인 필요

**해결 방안:**
```
config/index.ts 생성:
export const GameConfig = {
  ball: { /* 테마 */ },
  difficulty: { /* 난이도 */ },
  audio: { /* 사운드 */ },
  physics: { /* 물리 */ }
}
```

---

### 문제점 7: 테스트 코드 없음

**현재 상황:**
- 유닛 테스트 없음
- 수동 테스트만 진행
- 리그레션 위험

**해결 방안:**
```
__tests__/ 폴더 생성:
- Vitest 사용
- 핵심 로직 테스트 (난이도, 점수, 물리)
- CI/CD 파이프라인 통합
```

---

## 📊 리팩토링 우선순위 요약

| 순위 | 항목 | 예상 시간 | 효과 |
|-----|------|---------|------|
| 1 | Game 클래스 분리 | 2-3일 | ⭐⭐⭐⭐⭐ |
| 1 | 상태 관리 통합 | 1일 | ⭐⭐⭐⭐ |
| 2 | 타입 정의 정리 | 0.5일 | ⭐⭐⭐ |
| 2 | 에러 처리 추가 | 1일 | ⭐⭐⭐⭐ |
| 3 | 이벤트 시스템 | 1-2일 | ⭐⭐⭐ |
| 3 | Config 통합 | 0.5일 | ⭐⭐ |
| 3 | 테스트 코드 | 2-3일 | ⭐⭐⭐⭐ |

---

## 🎯 권장 진행 순서

**1단계 (1주일):**
- Game 클래스 분리
- 상태 관리 통합

**2단계 (3일):**
- 타입 정의 정리
- 에러 처리 추가

**3단계 (필요 시):**
- 이벤트 시스템
- 테스트 코드

---

## 💡 추가 고려사항

**성능 최적화:**
- 메모리 누수 체크 (Three.js dispose 패턴)
- 렌더링 최적화 (LOD, Frustum Culling)

**사용자 경험:**
- 로딩 시간 단축
- 터치 반응성 개선
- 오프라인 모드 지원

**유지보수:**
- 주석 표준화
- 컴포넌트 문서화
- 아키텍처 다이어그램 작성
